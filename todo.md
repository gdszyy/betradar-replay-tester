# UOF Replay 测试系统 - 任务清单

## 项目概述
一套完整的 Web 系统，用于测试 UOF（Unified Odds Feed）功能。包括 Replay 管理、比赛信息查询、AMQP 消息监听和可视化展示。

## 核心功能需求

### 1. 数据库设计
- [x] 设计比赛信息表（matches）
- [x] 设计消息日志表（messages）
- [x] 设计 Replay 会话表（replay_sessions）
- [x] 执行数据库迁移

### 2. 后端 API 开发

#### Replay 控制
- [x] 集成 replay_controller.py 到项目
- [x] 实现获取过去 48 小时比赛列表的 API
- [x] 实现添加比赛到 Replay 列表的 API
- [x] 实现启动 Replay 的 API（支持速度控制）
- [x] 实现暂停/停止 Replay 的 API
- [x] 实现获取 Replay 状态的 API
- [x] 实现重置 Replay 的 API

#### UOF 静态 API 集成
- [x] 实现获取比赛详情的 API（调用 UOF 静态 API）
- [x] 实现获取比赛摘要的 API
- [x] 实现获取比赛时间线的 API
- [x] 实现查询过去 48 小时比赛列表的 API

#### AMQP 消息监听
- [x] 实现 AMQP 连接管理
- [x] 实现消息接收和解析
- [x] 实现消息持久化到数据库
- [x] 实现 WebSocket 推送消息到前端

### 3. WebSocket 实时通信
- [x] 实现 WebSocket 服务器
- [x] 实现客户端连接管理
- [x] 实现实时消息推送
- [x] 实现 Replay 状态推送

### 4. 前端 UI 开发

#### 布局结构
- [x] 实现三栏布局（左侧列表、中间日志、右侧详情）
- [x] 实现底部播放控制条

#### 左侧回放列表
- [x] 实现比赛列表展示
- [x] 实现添加比赛到 Replay 列表功能
- [x] 实现移除比赛功能
- [x] 实现比赛信息展示（名称、时间、状态）
- [x] 实现选中比赛高亮

#### 中间日志列表
- [x] 实现消息列表展示
- [x] 实现全量消息视图
- [x] 实现单场比赛消息过滤视图
- [x] 实现消息卡片化展示（不同类型不同样式）
- [x] 实现消息类型图标和颜色
- [x] 实现消息时间戳展示
- [x] 实现消息点击选中功能
- [ ] 实现自动滚动到最新消息

#### 右侧消息详情
- [x] 实现消息详情展示
- [x] 实现 JSON 格式化展示
- [x] 实现消息元数据展示
- [ ] 实现复制消息内容功能

#### 底部播放控制条
- [x] 实现播放/暂停按钮
- [x] 实现停止按钮
- [x] 实现速度控制（1x, 2x, 5x, 10x）
- [ ] 实现进度条展示
- [x] 实现当前播放状态展示
- [ ] 实现比赛选择器

### 5. 配置管理
- [x] 添加 BETRADAR_ACCESS_TOKEN 环境变量
- [x] 添加 REPLAY_MQ_HOST 环境变量
- [x] 添加 UOF_API_BASE_URL 环境变量
- [x] 添加 AMQP 连接配置

### 6. 测试
- [x] 编写 Replay 控制器测试
- [ ] 编写 AMQP 监听器测试
- [ ] 编写 WebSocket 测试
- [x] 编写数据库操作测试
- [ ] 进行端到端测试

### 7. 文档
- [x] 编写系统架构文档
- [x] 编写 API 文档
- [x] 编写部署文档
- [x] 编写用户使用指南

## 技术栈

### 后端
- FastAPI（Python）- 用于 Replay 控制和 AMQP 监听
- Express + tRPC（Node.js）- 用于主 Web 服务
- WebSocket - 用于实时消息推送
- MySQL/TiDB - 数据持久化

### 前端
- React 19
- TypeScript
- TailwindCSS 4
- shadcn/ui 组件库
- Wouter（路由）
- tRPC（类型安全的 API 调用）

### 消息队列
- AMQP（RabbitMQ）- 接收 Betradar UOF 消息

## 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                     前端 React UI                            │
│  ┌──────────────┬─────────────────┬──────────────────┐     │
│  │  左侧列表    │   中间日志列表   │   右侧详情面板   │     │
│  │  - 比赛列表  │   - 消息卡片    │   - JSON 详情    │     │
│  │  - 控制按钮  │   - 类型过滤    │   - 元数据       │     │
│  └──────────────┴─────────────────┴──────────────────┘     │
│  ┌─────────────────────────────────────────────────────┐   │
│  │           底部播放控制条（音乐播放器风格）           │   │
│  │  播放/暂停 | 停止 | 速度 | 进度条 | 状态显示        │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                          ↕ WebSocket
┌─────────────────────────────────────────────────────────────┐
│              Express + tRPC 主服务                           │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  tRPC Procedures | WebSocket Server | Database      │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                          ↕ HTTP
┌─────────────────────────────────────────────────────────────┐
│              Python FastAPI 服务                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Replay Controller | AMQP Listener | UOF API Client │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                          ↕
┌─────────────────────────────────────────────────────────────┐
│              外部服务                                        │
│  Betradar Replay API | Betradar AMQP | UOF Static API      │
└─────────────────────────────────────────────────────────────┘
```

## 开发优先级

1. **P0（核心功能）**
   - 数据库设计
   - Replay 控制 API
   - AMQP 消息监听
   - WebSocket 实时推送
   - 基本 UI 布局

2. **P1（重要功能）**
   - UOF 静态 API 集成
   - 消息卡片化展示
   - 播放控制条
   - 消息详情展示

3. **P2（增强功能）**
   - 消息过滤和搜索
   - 导出消息日志
   - 性能优化
   - 错误处理优化

## 注意事项

- Replay 只能重播过去 48 小时的比赛
- AMQP 消息需要实时处理和持久化
- WebSocket 需要处理断线重连
- 前端需要处理大量消息的性能优化
- 需要支持多场比赛同时 Replay
- 播放控制需要精确的状态同步

## 错误修复

- [x] 修改 Replay API 为直接调用 Betradar 官方 API (https://api.betradar.com/v1/replay/)
- [x] 移除 Python Replay 服务依赖
- [x] 修复 Betradar API 认证（使用 x-access-token header）
- [x] 优化前端 API 错误处理（避免频繁错误提示）
- [x] 验证所有 API 端点正常工作
