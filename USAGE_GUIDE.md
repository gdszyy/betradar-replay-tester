# UOF Replay 测试系统 - 使用指南

## 系统概述

UOF Replay 测试系统是一个专业的 Web 应用程序，用于测试 Betradar Unified Odds Feed (UOF) 的各项功能。系统提供了完整的 Replay 管理、比赛信息查询、AMQP 消息监听和实时可视化展示功能。

## 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                     前端 React UI                            │
│  ┌──────────────┬─────────────────┬──────────────────┐     │
│  │  左侧列表    │   中间日志列表   │   右侧详情面板   │     │
│  │  - 比赛列表  │   - 消息卡片    │   - JSON 详情    │     │
│  │  - 控制按钮  │   - 类型过滤    │   - 元数据       │     │
│  └──────────────┴─────────────────┴──────────────────┘     │
│  ┌─────────────────────────────────────────────────────┐   │
│  │           底部播放控制条（音乐播放器风格）           │   │
│  │  播放/暂停 | 停止 | 速度 | 进度条 | 状态显示        │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                          ↕ WebSocket
┌─────────────────────────────────────────────────────────────┐
│              Express + tRPC 主服务                           │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  tRPC Procedures | WebSocket Server | Database      │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                          ↕ HTTP
┌─────────────────────────────────────────────────────────────┐
│              Python FastAPI 服务                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Replay Controller | AMQP Listener | UOF API Client │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                          ↕
┌─────────────────────────────────────────────────────────────┐
│              外部服务                                        │
│  Betradar Replay API | Betradar AMQP | UOF Static API      │
└─────────────────────────────────────────────────────────────┘
```

## 快速开始

### 1. 环境配置

系统需要以下环境变量（已在 Manus 平台自动配置）：

```bash
# Betradar 访问令牌
BETRADAR_ACCESS_TOKEN=oIUENTCkk9nCIv92uQ

# Replay MQ 服务器地址
REPLAY_MQ_HOST=global.replaymq.betradar.com

# UOF API 基础 URL
UOF_API_BASE_URL=https://api.betradar.com/v1

# Replay 服务端口
REPLAY_SERVICE_PORT=8001

# AMQP 路由键（可选，默认接收所有消息）
ROUTING_KEYS=#
```

### 2. 启动服务

系统包含三个主要服务：

#### 主 Web 服务（自动启动）
```bash
pnpm dev
```

#### Python Replay 服务（需要手动启动）
```bash
cd server
./start_replay_service.sh
```

#### AMQP 监听器（需要手动启动）
```bash
cd server
python3 amqp_listener.py
```

### 3. 访问系统

打开浏览器访问：`http://localhost:3000`

## 功能说明

### 左侧面板 - 回放列表管理

**添加比赛到 Replay 列表**

1. 在输入框中输入比赛 ID（例如：`12345678` 或 `sr:match:12345678`）
2. 点击 `+` 按钮或按 Enter 键添加
3. 比赛将出现在列表中

**移除比赛**

点击比赛卡片右侧的垃圾桶图标即可移除。

**刷新消息**

点击底部的"刷新消息"按钮可以从数据库重新加载消息。

### 中间面板 - 消息日志

**查看消息**

- 所有接收到的 AMQP 消息都会实时显示在此面板
- 消息按接收时间倒序排列（最新的在上面）
- 不同类型的消息使用不同的颜色标识：
  - `odds_change` - 蓝色
  - `bet_stop` - 红色
  - `bet_settlement` - 绿色
  - `bet_cancel` - 黄色
  - `fixture_change` - 紫色

**过滤消息**

使用顶部的下拉菜单可以：
- 查看所有消息
- 按特定比赛 ID 过滤消息

**选择消息**

点击任意消息卡片，右侧面板将显示该消息的详细信息。

### 右侧面板 - 消息详情

显示选中消息的完整信息：

- **基本信息**：消息类型、生产者、比赛 ID、接收时间
- **路由键**：AMQP 路由键
- **解析数据**：格式化的 JSON 数据
- **原始内容**：完整的 XML 消息内容

### 底部控制条 - 播放控制

**播放控制按钮**

- **播放** ▶️：启动 Replay（使用当前设置的速度）
- **暂停** ⏸️：暂停 Replay
- **停止** ⏹️：停止并重置 Replay

**速度控制**

选择 Replay 播放速度：
- 1x - 实时速度
- 2x - 2 倍速
- 5x - 5 倍速
- 10x - 10 倍速（默认）
- 20x - 20 倍速

**状态显示**

- **消息数**：当前接收到的消息总数
- **播放列表**：当前 Replay 列表中的比赛数量

## 工作流程

### 典型测试流程

1. **准备阶段**
   - 启动所有服务（主服务、Replay 服务、AMQP 监听器）
   - 确认系统状态为 `idle`

2. **添加比赛**
   - 在左侧面板输入要测试的比赛 ID
   - 添加一个或多个比赛到 Replay 列表

3. **配置播放**
   - 选择合适的播放速度（建议从 10x 开始）
   - 确认 AMQP 监听器已连接

4. **开始 Replay**
   - 点击播放按钮启动 Replay
   - 系统状态变为 `playing`
   - AMQP 消息开始接收并显示

5. **监控消息**
   - 在中间面板查看实时接收的消息
   - 点击消息查看详细信息
   - 使用过滤功能关注特定比赛

6. **停止测试**
   - 点击暂停按钮暂时停止
   - 点击停止按钮完全停止并清空列表

## 消息类型说明

### 常见 UOF 消息类型

- **odds_change**：赔率变化消息，最常见的消息类型
- **bet_stop**：停止投注消息
- **bet_settlement**：投注结算消息
- **bet_cancel**：投注取消消息
- **fixture_change**：赛程变更消息
- **alive**：心跳消息
- **snapshot_complete**：快照完成消息

### 消息生产者

- **LiveOdds**：实时赔率生产者
- **PrematchOdds**：赛前赔率生产者
- **BetPal**：投注结算生产者

## 高级功能

### 路由键配置

通过设置 `ROUTING_KEYS` 环境变量可以过滤接收的消息类型：

```bash
# 接收所有消息
ROUTING_KEYS=#

# 只接收实时赔率变化
ROUTING_KEYS=*.*.live.odds_change.#

# 接收足球赛事的实时赔率变化
ROUTING_KEYS=*.*.live.odds_change.1.#

# 接收多种类型（用逗号分隔）
ROUTING_KEYS=*.*.live.odds_change.#,*.pre.-.bet_settlement.#
```

### 数据库查询

系统自动将所有消息保存到数据库，可以通过以下方式查询：

1. 使用前端的"刷新消息"功能
2. 使用过滤功能查看特定比赛的消息
3. 直接访问数据库（通过 Manus 管理界面）

### WebSocket 订阅

前端通过 WebSocket 实时接收消息，支持：

- 全局消息广播
- 按比赛 ID 订阅
- 按会话 ID 订阅

## 故障排除

### 无法接收消息

**可能原因**：
1. AMQP 监听器未启动
2. 访问令牌无效
3. Replay 未启动
4. 路由键配置错误

**解决方法**：
1. 检查 AMQP 监听器日志
2. 验证 `BETRADAR_ACCESS_TOKEN` 是否正确
3. 确认 Replay 状态为 `playing`
4. 检查 `ROUTING_KEYS` 配置

### Replay 无法启动

**可能原因**：
1. Python Replay 服务未启动
2. 播放列表为空
3. 比赛 ID 格式错误

**解决方法**：
1. 启动 Python Replay 服务
2. 添加至少一个比赛到列表
3. 使用正确的比赛 ID 格式（数字或 `sr:match:xxxxx`）

### WebSocket 连接失败

**可能原因**：
1. 主服务未启动
2. 端口被占用
3. 浏览器不支持 WebSocket

**解决方法**：
1. 重启主服务
2. 检查端口 3000 是否可用
3. 使用现代浏览器（Chrome、Firefox、Edge）

## 性能优化

### 消息处理

- 系统默认只显示最新的 100 条消息
- 使用过滤功能减少显示的消息数量
- 定期清理数据库中的历史消息

### 播放速度

- 高速播放（20x）可能导致消息丢失
- 建议使用 10x 或更低的速度进行测试
- 对于详细测试，使用 1x 或 2x 速度

## 安全注意事项

1. **访问令牌**：不要在公开环境中暴露 `BETRADAR_ACCESS_TOKEN`
2. **数据库**：定期备份数据库，避免数据丢失
3. **网络**：确保 AMQP 连接使用 SSL（端口 5671）

## 技术支持

如遇到问题，请检查：

1. 浏览器控制台日志
2. 主服务日志（终端输出）
3. Python Replay 服务日志
4. AMQP 监听器日志

## 附录

### 比赛 ID 格式

Betradar 使用两种比赛 ID 格式：

- **数字格式**：`12345678`
- **URN 格式**：`sr:match:12345678`

系统支持两种格式，会自动处理转换。

### 时间限制

- Replay 只能重播**过去 48 小时**内的比赛
- 超过 48 小时的比赛将无法添加到 Replay 列表

### API 端点

系统提供以下 tRPC API 端点：

- `replay.start` - 启动 Replay
- `replay.stop` - 停止 Replay
- `replay.reset` - 重置 Replay
- `replay.getStatus` - 获取状态
- `replay.addToPlaylist` - 添加到播放列表
- `replay.removeFromPlaylist` - 从播放列表移除
- `replay.getPlaylist` - 获取播放列表
- `db.getAllMessages` - 获取所有消息
- `db.getMessagesByMatch` - 按比赛获取消息
